events {}

http {

    # ===== Origin 허용 조건 =====
    map $http_origin $cors_allow_origin {
        default "";
        "http://localhost:3000" "http://localhost:3000";
        "https://localhost:3000" "https://localhost:3000";
        "https://dlta.kr"       "https://dlta.kr";
        "http://dlta.kr"        "http://dlta.kr";
    }

    upstream order_service  { server host.docker.internal:5001; }
    upstream item_service   { server host.docker.internal:5002; }
    upstream member_service { server host.docker.internal:5003; }
    upstream common_service { server host.docker.internal:5004; }

    server {
        listen 5000;

        # ===== CORS HEADER =====
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Headers;

        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;

        # OPTIONS preflight 처리
        if ($request_method = OPTIONS) {
            return 204;
        }

        # ===================== ORDER =====================
        location /api/orders {
            proxy_pass http://order_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ===================== ITEM =====================
        location /api/items {
            proxy_pass http://item_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/category {
            proxy_pass http://item_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/colorItems {
            proxy_pass http://item_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/colorItemSizeStock {
            proxy_pass http://item_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ===================== MEMBER =====================
        location /api/member {
            proxy_pass http://member_service;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ===================== COMMON =====================
        location /common/api {
            proxy_pass http://common_service/api;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
